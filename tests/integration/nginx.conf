worker_processes 1;

error_log stderr warn;
pid /tmp/nginx.pid;

events {
    worker_connections 256;
}

http {
    lua_shared_dict ngx_stats 10m;
    lua_package_path '/etc/nginx/lua/?.lua;/etc/nginx/lua/?/init.lua;;';

    # Lua module initialization
    init_by_lua_file /etc/nginx/lua/resty/ngxstats/init.lua;

    # Logging
    access_log off;

    # Upstream for testing
    upstream test_backend {
        server upstream:80;
        keepalive 16;
    }

    # Main server - port 80
    server {
        listen 80;
        server_name localhost;

        # Log metrics for each request
        log_by_lua_file /etc/nginx/lua/resty/ngxstats/log.lua;

        # Simple endpoints
        location /hello {
            content_by_lua_block {
                ngx.say("Hello from test")
            }
        }

        # Various status code responses
        location /get {
            return 200 'OK';
            add_header Content-Type text/plain;
        }

        location /get/204 {
            return 204;
        }

        location /get/302 {
            return 302 /hello;
        }

        location /get/404 {
            return 404 'Not Found';
            add_header Content-Type text/plain;
        }

        location /get/500 {
            return 500 'Internal Server Error';
            add_header Content-Type text/plain;
        }

        # Upstream proxy endpoints
        location /proxy/ {
            proxy_pass http://test_backend/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }

        location /proxy/fast {
            proxy_pass http://test_backend/fast;
        }

        location /proxy/slow {
            proxy_pass http://test_backend/slow;
        }

        location /proxy/error/500 {
            proxy_pass http://test_backend/error/500;
        }

        location /proxy/error/502 {
            proxy_pass http://test_backend/error/502;
        }

        # Upstream timeout test
        location /proxy/timeout {
            proxy_pass http://test_backend/delay?ms=5000;
            proxy_connect_timeout 1s;
            proxy_read_timeout 1s;
        }

        # Bad upstream (connection refused)
        location /proxy/bad {
            proxy_pass http://127.0.0.1:59999/;
            proxy_connect_timeout 1s;
            proxy_read_timeout 1s;
        }
    }

    # Admin server - port 8080
    server {
        listen 8080;
        server_name localhost;

        # Allow all for testing
        allow all;

        location /status {
            access_by_lua_file /etc/nginx/lua/resty/ngxstats/status.lua;
            content_by_lua_file /etc/nginx/lua/resty/ngxstats/show.lua;
        }

        location = /nginx_status {
            stub_status;
        }
    }
}
